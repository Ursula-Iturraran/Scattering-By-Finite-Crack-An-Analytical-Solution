C     PROGRAMA PARA CALCULAR LA RESPUESTA EN FRECUENCIA 
C     DE UNA FISURA BIDIMENSIONAL PLANA ANTE
C     INCIDENCIA DE ONDAS SH
C     SE USA LA SOLUCION DE SOMMERFELD
C
      PARAMETER (NRECEPT=101)
      COMMON/PARCL/B1,B2,AL,AK
      COMMON/DE/UY
      COMPLEX SOMMER
      COMPLEX UY,B1,B2,AL,AK
      COMPLEX FDTUY1(NRECEPT,5),FDTUY2(NRECEPT,5)
      COMPLEX SUMY1(5),SUMY2(5)
      INTEGER IARCH(10)
      DIMENSION GAM(5)
      OPEN(11,FORM="FORMATTED",FILE="fdtsom1.s1")
      OPEN(12,FORM="FORMATTED",FILE="fdtsom1.s2")
      OPEN(13,FORM="FORMATTED",FILE="fdtsom1.s3")
      OPEN(14,FORM="FORMATTED",FILE="fdtsom1.s4")
      OPEN(15,FORM="FORMATTED",FILE="fdtsom1.s5")
      OPEN(21,FORM="FORMATTED",FILE="fdtsom2.s1")
      OPEN(22,FORM="FORMATTED",FILE="fdtsom2.s2")
      OPEN(23,FORM="FORMATTED",FILE="fdtsom2.s3")
      OPEN(24,FORM="FORMATTED",FILE="fdtsom2.s4")
      OPEN(25,FORM="FORMATTED",FILE="fdtsom2.s5")
      OPEN(26,FORM="FORMATTED",FILE="fdt.s")
C
C     FDT:  FUNCION DE TRANSFERENCIA
C
      WRITE(6,*)"DATOS: <NINC>"
      READ(5,*)
      READ(5,*)NINC
      WRITE(6,*)"DATOS: <GAM(INC),INC=1,NINC>"
      READ(5,*)
      READ(5,*)(GAM(INC),INC=1,NINC)
      WRITE(6,*)"DATOS: <XI,DX,NES>"
      READ(5,*)
      READ(5,*)XI,DX,NES
      WRITE(6,*)"DATOS: <T,N>"
      READ(5,*)
      READ(5,*)TT,N
      PI=4.0*ATAN(1.0)
      DO INC=1,NINC
       GAM(INC)=0.017453293*GAM(INC)
      END DO
  190 FORMAT(10F8.4)
  191 FORMAT(202F8.4)
   25 FORMAT(1X,F10.5,1X,F10.5,1X,I1)
      DO ICAS=1,NINC
       IARCH(ICAS)=10+ICAS
       TOTTO=0.01
       CALL ONDAS(GAM(ICAS),TOTO)
       TOTO=0.0
       CALL DESF(TOTO,TOTO)
       WRITE(IARCH(ICAS),*)0.0,0
       WRITE(IARCH(ICAS),190)(UY,IES=1,NES)
      END DO
      DO ICAS=1,NINC
       IARCH(ICAS+NINC)=20+ICAS
       TOTTO=0.01
       CALL ONDAS(GAM(ICAS),TOTO)
       TOTO=0.0
       CALL DESF(TOTO,TOTO)
       WRITE(IARCH(ICAS+NINC),*)0.0,0
       WRITE(IARCH(ICAS+NINC),190)(UY,IES=1,NES)
      END DO
      DO 30 J=1,N/2
       FJ=J/TT
       AKA=2.0*PI*FJ
       DO 90 IES=1,NES
        X=XI+DX*(IES-1)
        IF(ABS(X).LT.1.0)THEN
         Z=0.0
         DO IC=1,NINC
          SUMY1(IC)=SOMMER(X,AKA,GAM(IC))
          SUMY2(IC)=-SUMY1(IC)
         END DO
        ELSE
         Z=0.0
         DO ICAS=1,NINC
          SUMY1(ICAS)=(0.0,0.0)
          SUMY2(ICAS)=(0.0,0.0)
         END DO
        END IF
C
   40 CONTINUE
C
      DO ICAS=1,NINC
       CALL ONDAS(GAM(ICAS),AKA)
       CALL DESF(X,Z)
       FDTUY1(IES,ICAS)=UY+SUMY1(ICAS)
       FDTUY2(IES,ICAS)=UY+SUMY2(ICAS)
      END DO
C
   90 CONTINUE
C
      DO ICAS=1,NINC
        WRITE(IARCH(ICAS),*)FJ,J
        WRITE(IARCH(ICAS),190)(FDTUY1(IES,ICAS),IES=1,NES)
        WRITE(IARCH(ICAS+NINC),*)FJ,J
        WRITE(IARCH(ICAS+NINC),190)(FDTUY2(IES,ICAS),IES=1,NES)
      END DO
C
   30 CONTINUE
      STOP
      END
C
C     CALCULO DE LA SOLUCION DE FUNCIONES DE FRESNEL
C
      COMPLEX FUNCTION SOMMER(X,AKA,AGAM)
C
      COMPLEX UI,FAC,F,Z,Z1,Z2
      UI=(0.0,1.0)
      PI4=ATAN(1.0)
      PI=PI4*4.0
      DERP=2.0/SQRT(PI)
      AKX1=AKA*(1.0+X)
      AKX2=AKA*(1.0-X)
      AKASG=AKA*SIN(AGAM)
      AKXSG=AKASG*X
      AR1=SQRT(2.0*AKX1)*SIN(PI4-AGAM/2.0)
      AR11=SQRT(2.0*AKX1)
      AR2=SQRT(2.0*AKX2)*SIN(PI4+AGAM/2.0)
      AR21=SQRT(2.0*AKX2)
      AR3=SQRT(4.0*AKA)*SIN(PI4-AGAM/2.0)
      AR4=SQRT(4.0*AKA)*SIN(PI4+AGAM/2.0)
      AR5=SQRT(4.0*AKA)
      FAC=-CEXP(UI*AKXSG)
      FAC=FAC+CEXP(-UI*AKASG+UI*AKX1-UI*PI4)*F(AR1)*DERP
      FAC=FAC+CEXP(+UI*AKASG+UI*AKX2-UI*PI4)*F(AR2)*DERP
      Z=CEXP(UI*2.0*AKA-UI*PI4)*F(AR5)*DERP  
      Z1=Z*CEXP(+UI*AKX1-UI*PI4)*F(AR11)*DERP
      Z1=Z1-CEXP(+UI*AKX2-UI*PI4)*F(AR21)*DERP
      Z1=Z1/(1.0-Z*Z)
      Z2=Z*CEXP(+UI*AKX2-UI*PI4)*F(AR21)*DERP   
      Z2=Z2-CEXP(+UI*AKX1-UI*PI4)*F(AR11)*DERP
      Z2=Z2/(1.0-Z*Z)
      FAC=FAC+CEXP(-UI*AKASG+UI*2.0*AKA-UI*PI4)*F(AR3)*DERP*Z1
      FAC=FAC+CEXP(+UI*AKASG+UI*2.0*AKA-UI*PI4)*F(AR4)*DERP*Z2      
      FAC=CONJG(FAC) 
      SOMMER=-FAC
      RETURN
      END
C
      COMPLEX FUNCTION F(Z)
      COMPLEX UI,BAL
      UI=(0.0,1.0)
      PI=4.0*ATAN(1.0)
      AUX=SQRT(PI/2.0)
      IF(Z.GE.0.0)GO TO 10
      BAL=SQRT(PI)*CEXP(-UI*(Z*Z-PI/4.0))
      F=BAL-AUX*(GM(-Z/AUX)+UI*FM(-Z/AUX))
      RETURN
   10   F=AUX*(GM(Z/AUX)+UI*FM(Z/AUX))
      RETURN
      END
C
      FUNCTION GM(X)
      A=((6.67*X+3.492)*X+4.142)*X+2.0
      GM=1.0/A
      RETURN
      END
C
      FUNCTION FM(X)
      A=1.0+0.926*X
      B=(3.104*X+1.792)*X+2.0
      FM=A/B
      RETURN
      END
C
      SUBROUTINE DESF(X,Z)
      COMMON/DE/UY
      COMMON/PARCL/B1,B2,AL,AK
      COMPLEX UY,SXY,SZY,B1,B2,AL,AK
      COMPLEX UI
      COMPLEX AUX1,AUX2,PS2
      UI=(0.0,1.0)
      AUX1=B1*CEXP(UI*(AK*Z-AL*X))
      AUX2=B2*CEXP(-UI*(AK*Z+AL*X))
      UY=AUX1+AUX2
      PS2=AUX1-AUX2
      SXY=-UI*AL*UY
      SZY=+UI*AK*PS2
      RETURN
      END
C
      SUBROUTINE ONDAS(GS,AKB)
      COMMON/PARCL/B1,B2,AL,AK
      COMPLEX B1,B2,ZER,AL,AK
      ZER=(0.0,0.0)
      B1=(1.0,0.0)
C     B2=(1.0,0.0)
      B2=(0.0,0.0)
      AL=AKB*SIN(GS)+ZER
      AK=AKB*COS(GS)+ZER
      RETURN
      END
C
    
       







